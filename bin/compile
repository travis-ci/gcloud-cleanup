#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

indent() {
  # if an arg is given it's a flag indicating we shouldn't indent the first
  # line, so use :+ to tell SED accordingly if that parameter is set, otherwise
  # null string for no range selector prefix (it selects from line 2 onwards and
  # then every 1st line, meaning all lines)
  c="${1:+"2,999"} s/^/       /"
  case $(uname) in
    Darwin) sed -l "$c";; # mac/bsd sed: -l buffers on line boundaries
    *)      sed -u "$c";; # unix/gnu sed: -u unbuffered (arbitrary) chunks of data
  esac
}

mkdir -p "$1" "$2" "$3"

BUILD_DIR=$(cd "$1/" && pwd)
CACHE_DIR=$(cd "$2/" && pwd)
ENV_DIR=$(cd "$3/" && pwd)
BUILDPACK_DIR=$(dirname $(dirname $0))

PATH="$BUILD_DIR/build/linux/amd64:$PATH:$BUILD_DIR/bin:$CACHE_DIR/bin"

mkdir -p "$BUILD_DIR/bin" "$CACHE_DIR/bin"

if ! command -v gimme ; then
  curl \
    -sSL \
    -o "$CACHE_DIR/bin/gimme" \
    https://raw.githubusercontent.com/travis-ci/gimme/master/gimme
  chmod +x "$CACHE_DIR/bin/gimme"
fi

eval "$(gimme 1.5.1)" 2>&1 | indent
cd "$BUILD_DIR"

if ! test -f $CACHE_DIR/.profile.d/homebin.sh ; then
  echo 'PATH=$PATH:$HOME/build/linux/amd64:$HOME/bin' > $CACHE_DIR/.profile.d/homebin.sh
fi

echo "-----> Syncing cache dir to build dir... "
rsync -az $CACHE_DIR/ $BUILD_DIR/ | indent

echo "-----> Fetching deps"
make deps 2>&1 | indent

echo "-----> Building"
make crossbuild 2>&1 | indent
